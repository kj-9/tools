<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS Reader</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .input-group {
            display: flex;
            margin-bottom: 20px;
        }
        #rss-url {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
            font-size: 16px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 0 4px 4px 0;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .feed-info {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .feed-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .feed-description {
            color: #666;
            margin-bottom: 10px;
        }
        .article {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .article-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .article-title a {
            color: #2c3e50;
            text-decoration: none;
        }
        .article-title a:hover {
            text-decoration: underline;
        }
        .article-date {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .article-content {
            margin-bottom: 10px;
        }
        .article-link {
            color: #3498db;
        }
        .error {
            color: #e74c3c;
            padding: 10px;
            background-color: #fadbd8;
            border-radius: 4px;
        }
        .loading {
            color: #7f8c8d;
            font-style: italic;
        }
        .share-url {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
        }
        .copy-btn {
            background-color: #2ecc71;
            border-radius: 4px;
            margin-left: 10px;
        }
        .copy-btn:hover {
            background-color: #27ae60;
        }
    </style>
</head>
<body>
    <h1>RSS Reader</h1>
    
    <div class="input-group">
        <input type="text" id="rss-url" placeholder="Enter RSS feed URL" value="">
        <button id="load-btn">Load Feed</button>
    </div>
    
    <div id="share-section" class="share-url" style="display: none;">
        <span>Shareable URL:</span>
        <span id="share-url-text"></span>
        <button id="copy-btn" class="copy-btn">Copy</button>
    </div>
    
    <div id="feed-container">
        <p>Enter an RSS feed URL above to get started.</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlInput = document.getElementById('rss-url');
            const loadButton = document.getElementById('load-btn');
            const feedContainer = document.getElementById('feed-container');
            const shareSection = document.getElementById('share-section');
            const shareUrlText = document.getElementById('share-url-text');
            const copyButton = document.getElementById('copy-btn');
            
            // Check if URL has a feed parameter
            const urlParams = new URLSearchParams(window.location.search);
            const feedParam = urlParams.get('feed');
            
            if (feedParam) {
                try {
                    // Decode the URL parameter
                    const decodedUrl = decodeURIComponent(feedParam);
                    urlInput.value = decodedUrl;
                    loadFeed(decodedUrl);
                } catch (e) {
                    showError("Invalid URL in parameter");
                }
            }
            
            // Event listeners
            loadButton.addEventListener('click', function() {
                const url = urlInput.value.trim();
                if (url) {
                    loadFeed(url);
                    updateShareUrl(url);
                } else {
                    showError("Please enter a valid RSS feed URL");
                }
            });
            
            copyButton.addEventListener('click', function() {
                const shareUrl = shareUrlText.textContent;
                navigator.clipboard.writeText(shareUrl).then(function() {
                    copyButton.textContent = "Copied!";
                    setTimeout(function() {
                        copyButton.textContent = "Copy";
                    }, 2000);
                });
            });
            
            function updateShareUrl(feedUrl) {
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('feed', encodeURIComponent(feedUrl));
                shareUrlText.textContent = currentUrl.toString();
                shareSection.style.display = 'block';
                
                // Update browser URL without reloading the page
                window.history.pushState({}, '', currentUrl.toString());
            }
            
            function loadFeed(url) {
                feedContainer.innerHTML = '<p class="loading">Loading feed...</p>';
                
                // Use a CORS proxy to avoid CORS issues
                const corsProxy = 'https://api.allorigins.win/raw?url=';
                const proxyUrl = corsProxy + encodeURIComponent(url);
                
                fetch(proxyUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.text();
                    })
                    .then(data => {
                        parseFeed(data);
                    })
                    .catch(error => {
                        showError("Failed to load feed: " + error.message);
                    });
            }
            
            function parseFeed(xmlText) {
                try {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                    
                    // Check if parsing failed
                    if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                        throw new Error("Invalid XML");
                    }
                    
                    let feedTitle, feedDescription, feedLink, items = [];
                    
                    // Check if RSS or Atom
                    if (xmlDoc.querySelector('rss')) {
                        // RSS Feed
                        const channel = xmlDoc.querySelector('channel');
                        if (!channel) throw new Error("Invalid RSS format");
                        
                        feedTitle = getElementText(channel, 'title');
                        feedDescription = getElementText(channel, 'description');
                        feedLink = getElementText(channel, 'link');
                        
                        const itemElements = channel.querySelectorAll('item');
                        itemElements.forEach(item => {
                            // Fix for content:encoded - now properly handling namespaced elements
                            let content = '';
                            // Try to find content:encoded or any similarly namespaced element
                            const contentElements = item.getElementsByTagName('*');
                            for (let i = 0; i < contentElements.length; i++) {
                                const el = contentElements[i];
                                if (el.nodeName.toLowerCase().includes('content') && 
                                    el.nodeName.toLowerCase().includes('encoded')) {
                                    content = el.textContent;
                                    break;
                                }
                            }
                            
                            // If no content:encoded found, fall back to description
                            if (!content) {
                                content = getElementText(item, 'description');
                            }
                            
                            items.push({
                                title: getElementText(item, 'title'),
                                link: getElementText(item, 'link'),
                                description: getElementText(item, 'description'),
                                pubDate: getElementText(item, 'pubDate'),
                                content: content
                            });
                        });
                    } else if (xmlDoc.querySelector('feed')) {
                        // Atom Feed
                        const feed = xmlDoc.querySelector('feed');
                        if (!feed) throw new Error("Invalid Atom format");
                        
                        feedTitle = getElementText(feed, 'title');
                        feedDescription = getElementText(feed, 'subtitle');
                        
                        const linkElement = feed.querySelector('link[rel="alternate"]') || feed.querySelector('link');
                        feedLink = linkElement ? linkElement.getAttribute('href') : '';
                        
                        const entryElements = feed.querySelectorAll('entry');
                        entryElements.forEach(entry => {
                            const entryLink = entry.querySelector('link') ? 
                                entry.querySelector('link').getAttribute('href') : '';
                            
                            items.push({
                                title: getElementText(entry, 'title'),
                                link: entryLink,
                                description: getElementText(entry, 'summary'),
                                pubDate: getElementText(entry, 'published') || getElementText(entry, 'updated'),
                                content: getElementText(entry, 'content') || getElementText(entry, 'summary')
                            });
                        });
                    } else {
                        throw new Error("Unknown feed format");
                    }
                    
                    displayFeed(feedTitle, feedDescription, feedLink, items);
                } catch (error) {
                    showError("Failed to parse feed: " + error.message);
                }
            }
            
            function getElementText(parent, tagName) {
                const element = parent.querySelector(tagName);
                return element ? element.textContent : '';
            }
            
            function displayFeed(title, description, link, items) {
                let html = `
                    <div class="feed-info">
                        <div class="feed-title">${escapeHTML(title)}</div>
                        <div class="feed-description">${escapeHTML(description)}</div>
                        ${link ? `<a href="${escapeHTML(link)}" target="_blank">Visit Website</a>` : ''}
                    </div>
                `;
                
                if (items.length === 0) {
                    html += '<p>No items found in this feed.</p>';
                } else {
                    items.forEach(item => {
                        const date = formatDate(item.pubDate);
                        
                        html += `
                            <div class="article">
                                <div class="article-title">
                                    <a href="${escapeHTML(item.link)}" target="_blank">${escapeHTML(item.title)}</a>
                                </div>
                                ${date ? `<div class="article-date">${date}</div>` : ''}
                                <div class="article-content">${sanitizeHTML(item.content)}</div>
                                <a href="${escapeHTML(item.link)}" target="_blank" class="article-link">Read more</a>
                            </div>
                        `;
                    });
                }
                
                feedContainer.innerHTML = html;
            }
            
            function formatDate(dateString) {
                if (!dateString) return '';
                
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return dateString;
                    
                    return date.toLocaleString(undefined, {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return dateString;
                }
            }
            
            function sanitizeHTML(html) {
                if (!html) return '';
                
                // Create a temporary div
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Remove potentially dangerous elements and attributes
                const scripts = tempDiv.querySelectorAll('script, iframe, object, embed');
                scripts.forEach(el => el.remove());
                
                // Remove event handlers
                const allElements = tempDiv.querySelectorAll('*');
                allElements.forEach(el => {
                    Array.from(el.attributes).forEach(attr => {
                        if (attr.name.startsWith('on')) {
                            el.removeAttribute(attr.name);
                        }
                    });
                });
                
                return tempDiv.innerHTML;
            }
            
            function escapeHTML(str) {
                if (!str) return '';
                return str
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }
            
            function showError(message) {
                feedContainer.innerHTML = `<div class="error">${escapeHTML(message)}</div>`;
            }
        });
    </script>
</body>
</html>